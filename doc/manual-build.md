# How to build Raspberry Pi image manually

## Abstracts

The building process of Ubuntu Kylin image is mainly divided into the following steps:

* Generate a base filesystem, this step include installing the minimal Ubuntu base tools to disk.
* Install(compile) Linux kernel for raspi and Linux firmware for raspi.
* Compile uboot, to generate uboot binary file of raspi.
* Install necessary system services, such as `openssh-server`, `NetworkManager`.
* Install UKUI desktop environment.
* System configurations.

## Recommended build environment

The entire manual build process can theoretically be done on any Debian-based distribution, but I still recommend completing the build in such an environment.

* OS(distro): Ubuntu Server Focal.
* Machine: Raspberry Pi 4 (>=4GB) with 16GB+ micro sdcard.
* User: `root`

## Generate base filesystem

Before proceeding with this section, you need to make sure that you have installed `debootstrap`.

`debootstrap` is a tool which will install a Debian/Ubuntu base system into a subdirectory of another, already installed system. It doesn't require an installation CD, just access to a Debian/Ubuntu repository. Then to setup a Ubuntu Focal system.

```bash
mkdir -p ukfs;
debootstrap focal ukfs/ # or: debootstrap focal ukfs/ http://ports.ubuntu.com/ubuntu-ports/
```

This will obtain the base packages needed for the base filesystem from _http://ports.ubuntu.com/ubuntu-ports/_, install and configure the package to `ukfs/`. This takes a while to run, and when it's done you'll get a directory like this.

```
root@ubuntukylin:/pi# ls -lAh ukfs/
total 60K
lrwxrwxrwx  1 root root    7 Aug  5 16:35 bin -> usr/bin
drwxr-xr-x  2 root root 4.0K Apr 15 11:09 boot
drwxr-xr-x  4 root root 4.0K Aug  5 16:35 dev
drwxr-xr-x 59 root root 4.0K Aug  5 16:38 etc
drwxr-xr-x  2 root root 4.0K Apr 15 11:09 home
lrwxrwxrwx  1 root root    7 Aug  5 16:35 lib -> usr/lib
drwxr-xr-x  2 root root 4.0K Aug  5 16:35 media
drwxr-xr-x  2 root root 4.0K Aug  5 16:35 mnt
drwxr-xr-x  2 root root 4.0K Aug  5 16:35 opt
drwxr-xr-x  2 root root 4.0K Apr 15 11:09 proc
drwx------  2 root root 4.0K Aug  5 16:35 root
drwxr-xr-x  8 root root 4.0K Aug  5 16:38 run
lrwxrwxrwx  1 root root    8 Aug  5 16:35 sbin -> usr/sbin
drwxr-xr-x  2 root root 4.0K Aug  5 16:35 srv
drwxr-xr-x  2 root root 4.0K Apr 15 11:09 sys
drwxrwxrwt  2 root root 4.0K Aug  5 16:38 tmp
drwxr-xr-x 10 root root 4.0K Aug  5 16:35 usr
drwxr-xr-x 11 root root 4.0K Aug  5 16:35 var
```

This file system include: `ubuntu-minimal`, `systemd`, and _base filesystem_.

## Install Linux kernel and Linux firmware for raspi

After the base file system has been built, the next steps need to be done in the `chroot` to `ukfs/` directory.There are a few necessary tasks that need to be done before this section can proceed.

### Mounting the necessary filesystems

Follow the installation documentation for [gentoo](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base) as a reference. In a few moments, the Linux root will be changed towards the new location. To make sure that the new environment works properly, certain filesystems need to be made available there as well.

The filesystems that need to be made available are:

* `/proc/` which is a pseudo-filesystem (it looks like regular files, but is actually generated on-the-fly) from which the Linux kernel exposes information to the environment.
* `/sys/` which is a pseudo-filesystem, like `/proc/` which it was once meant to replace, and is more structured than `/proc/`.
* `/dev/` is a regular file system, partially managed by the Linux device manager (usually udev), which contains all device files.

The `/proc/` location will be mounted on `ukfs/proc/` whereas the other two are bind-mounted. The latter means that, for instance, `ukfs/sys/` will actually be `/sys/` (it is just a second entry point to the same filesystem) whereas `ukfs/proc/` is a new mount (instance so to speak) of the filesystem.

```bash
mount --types proc /proc ukfs/proc;
mount --rbind /sys ukfs/sys;
mount --make-rslave ukfs/sys;    
mount --rbind /dev ukfs/dev;
mount --make-rslave ukfs/dev;
```

### Copy APT data sources file

`apt` will retrieve the repository data from the url that specified in `sources.list`. You can copy [data/etc/apt/sources.list](https://github.com/ukui/pi/blob/master/data/etc/apt/sources.list) to `ukfs/etc/apt/sources.list`.

Now, you can `chroot` to the `ukfs/`, and modify the `bash` prompt.

```bash
chroot ukfs/;
export PS1="(chroot) \w \$ ";
```

Remove all the old lists file that generated by debootstrap, update repository data again.

```bash
rm /var/lib/apt/lists/*;
apt-get update;
```

Install complete Raspberry Pi Linux kernel and headers, then also install Raspberry Pi 2/3/4 GPU firmware and bootloaders.

```bash
mkdir -p /boot/firmware;
apt-get install linux-raspi2; # linux-raspi2 is dummy transitional packages, same as linux-raspi
apt-get install linux-firmware-raspi2;
```

## Install useful services for raspi

### openssh-server

Because the Raspberry Pi component did not contained any monitor, the ssh connection service is useful when the graphical environment failed to boot properly, so let's install it first.

```bash
apt-get install openssh-server;
```

### software-properties-common

`software-properties-common` provides an abstraction of the used apt repositories. It allows you to easily manage your distribution and independent software vendor software sources.

```bash
apt-get install software-properties-common
```

## Install UKUI desktop environment

We can get the whole lists of packages that include in Ubuntu Kylin from [UbuntuKylin seeds](https://people.canonical.com/~ubuntu-archive/seeds/ubuntukylin.focal/desktop). Install the entire Ubuntu Kylin suite, not just UKUI.

```bash
apt-get install avahi-autoipd network-manager-gnome network-manager-pptp-gnome libproxy1-plugin-gsettings libproxy1-plugin-networkmanager ppp pppconfig pppoeconf kylin-nm net-tools mate-notification-daemon mate-terminal im-config fcitx fcitx-frontend-gtk2 fcitx-frontend-gtk3 fcitx-frontend-qt5 fcitx-ui-classic fcitx-ui-qimpanel fcitx-table fcitx-module-cloudpinyin fcitx-googlepinyin apport-gtk whoopsie thunderbird thunderbird-gnome-support lightdm app-install-data-partner transmission-gtk system-config-printer baobab gnome-system-log gnome-font-viewer gucharmap  language-selector-gnome firefox xul-ext-ubufox rhythmbox software-properties-gtk ubuntu-release-upgrader-gtk update-manager update-notifier yelp zenity xdg-utils xdg-user-dirs xdg-user-dirs-gtk pulseaudio pulseaudio-module-bluetooth gvfs-bin gvfs-fuse gnome-disk-utility remmina shotwell deja-dup xdiagnose libcanberra-pulse ubuntu-kylin-software-center gnome-keyring seahorse libpam-gnome-keyring gnupg-agent ubuntu-artwork ubuntu-sounds gnome-session-canberra dmz-cursor-theme fonts-noto fonts-noto-color-emoji ubuntu-settings ubuntukylin-default-settings gstreamer1.0-alsa gstreamer1.0-plugins-base-apps gstreamer1.0-pulseaudio  gnome-accessibility-themes orca onboard brltty xcursor-themes speech-dispatcher mousetweaks at-spi2-core libatk-adaptor doc-base ubuntu-kylin-docs ubuntukylin-desktop libwmf0.2-7-gtk ukui-greeter youker-assistant ubuntukylin-wallpapers ubuntukylin-keyring firefox-locale-zh-hans thunderbird-locale-zh-hans thunderbird-locale-zh-cn ubuntukylin-theme indicator-china-weather ukui-desktop-environment  ukui-menu ukui-session-manager ukui-control-center ukui-screensaver peony ukui-media ukui-panel ukui-sidebar ukui-settings-daemon ukui-power-manager kylin-display-switch ukui-window-switch kylin-burner kylin-video ukui-polkit qt5-ukui-platformtheme mate-calc pluma mate-system-monitor atril kylin-user-guide libfprint-dev peony-extensions  ukui-biometric-manager ukui-keyring ukui-system-monitor ukui-kwin #ukwm ukui-biometric-auth biometric-authentication
```
